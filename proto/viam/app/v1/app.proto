syntax = "proto3";

package viam.app.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "go.viam.com/api/app/v1";

service AppService {
  // Organization
  //

  // Create an organization
  rpc CreateOrganization(CreateOrganizationRequest) returns (CreateOrganizationResponse);

  // List all organizations 
  rpc ListOrganizations(ListOrganizationsRequest) returns (ListOrganizationsResponse);

  // Get an organization
  rpc GetOrganization(GetOrganizationRequest) returns (GetOrganizationResponse);
  
  // Update an organization
  rpc UpdateOrganization(UpdateOrganizationRequest) returns (UpdateOrganizationResponse);

  // Delete an organization
  rpc DeleteOrganization(DeleteOrganizationRequest) returns (DeleteOrganizationResponse);

  // List all members of an organization
  rpc ListOrganizationMembers(ListOrganizationMembersRequest) returns (ListOrganizationMembersResponse);

  // Create an organization invite to an organization
  rpc CreateOrganizationInvite(CreateOrganizationInviteRequest) returns (CreateOrganizationInviteResponse);
  
  // Delete an organization member from an organization
  rpc DeleteOrganizationMember(DeleteOrganizationMemberRequest) returns (DeleteOrganizationMemberResponse);

  // Delete an organization invite
  rpc DeleteOrganizationInvite(DeleteOrganizationInviteRequest) returns (DeleteOrganizationInviteResponse);

  // Location
  //

  // Create a location
  rpc CreateLocation(CreateLocationRequest) returns (CreateLocationResponse);

  // List all locations
  rpc ListLocations(ListLocationsRequest) returns (ListLocationsResponse);

  // Get a location
  rpc GetLocation(GetLocationRequest) returns (GetLocationResponse);

  // Update a location
  rpc UpdateLocation(UpdateLocationRequest) returns (UpdateLocationResponse);

  // Delete a location
  rpc DeleteLocation(DeleteLocationRequest) returns (DeleteLocationResponse);

  // Share a location with an organization
  rpc ShareLocation(ShareLocationRequest) returns (ShareLocationResponse);

  // Stop sharing a location with an organization
  rpc UnshareLocation(UnshareLocationRequest) returns (UnshareLocationResponse);

  // Get a location's authorization secrets
  rpc LocationAuth(LocationAuthRequest) returns (LocationAuthResponse);

  // Create a new generated Secret in the Location.
  //  - Succeeds if there are no more than 2 active secrets after creation.
  rpc CreateLocationSecret(CreateLocationSecretRequest) returns (CreateLocationSecretResponse);

  // Delete a Secret from the Location.
  rpc DeleteLocationSecret(DeleteLocationSecretRequest) returns (DeleteLocationSecretResponse);

  // Fragment
  //

  // Create a fragment
  rpc CreateFragment(CreateFragmentRequest) returns (CreateFragmentResponse);

  // List all fragments
  rpc ListFragments(ListFragmentsRequest) returns (ListFragmentsResponse);

  // Get a fragment
  rpc GetFragment(GetFragmentRequest) returns (GetFragmentResponse);

  // Update a fragment
  rpc UpdateFragment(UpdateFragmentRequest) returns (UpdateFragmentResponse);

  // Delete a fragment
  rpc DeleteFragment(DeleteFragmentRequest) returns (DeleteFragmentResponse);

  // Robot
  //

  // Get a specific robot by ID
  rpc GetRobot(GetRobotRequest) returns (GetRobotResponse);

  rpc ListRobotParts(ListRobotPartsRequest) returns (ListRobotPartsResponse);

  // Get a specific robot part by ID
  rpc GetRobotPart(GetRobotPartRequest) returns (GetRobotPartResponse);

  rpc ListRobotPartLogs(ListRobotPartLogsRequest) returns (ListRobotPartLogsResponse);

  rpc TailRobotPartLogs(TailRobotPartLogsRequest) returns (stream TailRobotPartLogsResponse);

  // Get a specific robot part histy by ID
  rpc GetRobotPartHistory(GetRobotPartHistoryRequest) returns (GetRobotPartHistoryResponse);

  // Update a robot
  rpc UpdateRobotPart(UpdateRobotPartRequest) returns (UpdateRobotPartResponse);

  // Create a new robot part
  rpc CreateRobotPart(CreateRobotPartRequest) returns (CreateRobotPartResponse);

  // Delete a robot part
  rpc DeleteRobotPart(DeleteRobotPartRequest) returns (DeleteRobotPartResponse);

  // Marks the given part as the main part, and all the others as not
  rpc MarkPartAsMain(MarkPartAsMainRequest) returns (MarkPartAsMainResponse);

  // Create a new generated Secret in the Robot Part.
  //  - Succeeds if there are no more than 2 active secrets after creation.
  rpc CreateRobotPartSecret(CreateRobotPartSecretRequest) returns (CreateRobotPartSecretResponse);

  // Delete a Secret from the RobotPart.
  rpc DeleteRobotPartSecret(DeleteRobotPartSecretRequest) returns (DeleteRobotPartSecretResponse);

  // Finds robots given a query
  rpc ListRobots(ListRobotsRequest) returns (ListRobotsResponse);

  // CreateRobot creates a new robot
  rpc CreateRobot(CreateRobotRequest) returns (CreateRobotResponse);

  // UpdateRobot updates a robot
  rpc UpdateRobot(UpdateRobotRequest) returns (UpdateRobotResponse);

  // DeleteRobot deletes a robot
  rpc DeleteRobot(DeleteRobotRequest) returns (DeleteRobotResponse);
}

// Organization
//

message OrganizationMember {
  string user_id = 1;
  google.protobuf.Timestamp date_added = 2;
}

message Organization {
  string id = 1;
  string name = 2;
  google.protobuf.Timestamp created_on = 3;
}

message OrganizationInvite {
  string organization_id = 2;
  string email = 3;
  google.protobuf.Timestamp created_on = 4;
}

message CreateOrganizationRequest {
  Organization organization = 1;
}

message CreateOrganizationResponse {
  Organization organization = 1;
}

message ListOrganizationsRequest {}

message ListOrganizationsResponse {
  repeated Organization organizations = 1;
}

message GetOrganizationRequest {
  string organization_id = 1;
}

message GetOrganizationResponse {
  Organization organization = 1;
}

message UpdateOrganizationRequest {
  string organization_id = 1;
  string name = 2;
}

message UpdateOrganizationResponse {
  Organization organization = 1;
}

message DeleteOrganizationRequest {
  string organization_id = 1;
}

message DeleteOrganizationResponse {}

message ListOrganizationMembersRequest {
  string organization_id = 1;
}

message ListOrganizationMembersResponse {
  string organization_id = 1;
  repeated OrganizationMember members = 2;
  repeated OrganizationInvite invites = 3;
}

message CreateOrganizationInviteRequest {
  string organization_id = 1;
  string email = 2;
}

message CreateOrganizationInviteResponse {
  OrganizationInvite invite = 1;
}

message DeleteOrganizationMemberRequest {
  string organization_id = 1;
  string user_id = 2;
}

message DeleteOrganizationMemberResponse {}

message DeleteOrganizationInviteRequest {
  string organization_id = 1;
  string email = 2;
}

message DeleteOrganizationInviteResponse {}

// Location
//

message LocationOrganization {
  string organization_id = 1;
  bool primary = 2;
}

// SharedSecret is a secret used for LocationAuth and RobotParts.
message SharedSecret {
  enum State {
    STATE_UNSPECIFIED = 0;
    // Secret is enabled and can be used in authentication.
    STATE_ENABLED = 1;
    // Secret is disabled and must not be used to authenticate to rpc.
    STATE_DISABLED = 2;
  }

  string id = 1;

  // The payload of the secret. Used during authentication to the rpc framework.
  string secret = 2;

  // Date/time the secret was first created.
  google.protobuf.Timestamp created_on = 3;

  // State of the shared secret. In most cases it should be enabled. We may support
  // disabling a specific secret while keeping it in the database.
  State state = 4;
}

message LocationAuth {
  // Deprecated: use secrets field.
  string secret = 1 [deprecated = true];

  // Location ID containing this LocationAuth.
  string location_id = 2;

  // List of secrets used to authenticate to the Location.
  repeated SharedSecret secrets = 3;
}

message Location {
  string id = 1;
  string name = 2;
  string parent_location_id = 3;
  LocationAuth auth = 4;
  bool assigned = 5;
  repeated LocationOrganization organizations = 6;
  google.protobuf.Timestamp created_on = 7;
}

message CreateLocationRequest {
  string organization_id = 1;
  string name = 2;
  optional string parent_location_id = 3;
}

message CreateLocationResponse {
  Location location = 1;
}

message ListLocationsRequest {
  string organization_id = 1;
}

message ListLocationsResponse {
  repeated Location locations = 1;
}

message GetLocationRequest {
  string location_id = 1;
}

message GetLocationResponse {
  Location location = 1;
}

message UpdateLocationRequest {
  string location_id = 1;
  string name = 2;
  optional string parent_location_id = 3;
}

message UpdateLocationResponse {
  Location location = 1;
}

message DeleteLocationRequest {
  string location_id = 1;
}

message DeleteLocationResponse {}

message ShareLocationRequest {
  string location_id = 1;
  string organization_id = 2;
}

message ShareLocationResponse {}

message UnshareLocationRequest {
  string location_id = 1;
  string organization_id = 2;
}

message UnshareLocationResponse {}

message CreateLocationSecretRequest {
  // Location ID to create the secret in.
  string location_id = 1;
}

message CreateLocationSecretResponse {
  // Location's auth after updates.
  LocationAuth auth = 1;
}

message DeleteLocationSecretRequest {
  string location_id = 1;
  string secret_id = 2;
}
message DeleteLocationSecretResponse {}

message LocationAuthRequest {
  string location_id = 1;
}

message LocationAuthResponse {
  LocationAuth auth = 1;
}

// Fragment
//

message Fragment {
  string id = 1;
  string organization_id = 4;
  string name = 2;
  google.protobuf.Struct config = 3;
  bool public = 5;
  google.protobuf.Timestamp created_on = 6;
}

message CreateFragmentRequest {
  Fragment fragment = 1;
}

message CreateFragmentResponse {
  Fragment fragment = 1;
}

message ListFragmentsRequest {
  string organization_id = 1;
  bool include_public = 2;
}

message ListFragmentsResponse {
  repeated Fragment fragments = 1;
}

message GetFragmentRequest {
  string fragment_id = 1;
}

message GetFragmentResponse {
  Fragment fragment = 1;
}

message UpdateFragmentRequest {
  string name = 2;
  google.protobuf.Struct config = 3;
}

message UpdateFragmentResponse {
  Fragment fragment = 1;
}

message DeleteFragmentRequest {
  string fragment_id = 1;
}

message DeleteFragmentResponse {}

// Robot
//

message Robot {
  string id = 1;
  string name = 2;
  string location = 3;
  google.protobuf.Timestamp last_access = 4;
  google.protobuf.Timestamp created_on = 5;
}

message RobotPart {
  string id = 1;
  string name = 2;
  // dns_name part name used for fqdn and local fqdn. Anytime the Name is updated this should be sanitized and updated as well.
  string dns_name = 10;
  string secret = 3;
  string robot = 4;
  // Store the location_id to allow for unique indexes across parts and locations. This filed MUST be updated each time the robots location
  // changes.
  string location_id = 12;
  google.protobuf.Struct robot_config = 5;
  google.protobuf.Timestamp last_access = 6;
  google.protobuf.Struct user_supplied_info = 7;
  bool main_part = 8;
  string fqdn = 9;
  string local_fqdn = 11;
  google.protobuf.Timestamp created_on = 13;

  // List of secrets allowed for authentication.
  repeated SharedSecret secrets = 14;
}

message RobotPartHistoryEntry {
  string part_id = 1;
  string robot_id = 2;
  google.protobuf.Timestamp when = 3;
  RobotPart old = 4;
}

message GetRobotRequest {
  string id = 1;
}

message GetRobotResponse {
  Robot robot = 1;
}

message ListRobotPartsRequest {
  string robot_id = 1;
}

message ListRobotPartsResponse {
  repeated RobotPart parts = 1;
}

message GetRobotPartRequest {
  string id = 1;
}

message GetRobotPartResponse {
  RobotPart part = 1;
}

message ListRobotPartLogsRequest {
  string part_id = 1;
  bool errors_only = 2;
}

message LogEntry {
  string host = 1;
  string level = 2;
  google.protobuf.Timestamp time = 3;
  string logger_name = 4;
  string message = 5;
  google.protobuf.Struct caller = 6;
  string stack = 7;
  repeated google.protobuf.Struct fields = 8;
}

message ListRobotPartLogsResponse {
  repeated LogEntry logs = 1;
}

message TailRobotPartLogsRequest {
  string part_id = 1;
  bool errors_only = 2;
}

message TailRobotPartLogsResponse {
  repeated LogEntry logs = 1;
}

message GetRobotPartHistoryRequest {
  string part_id = 1;
}

message GetRobotPartHistoryResponse {
  repeated RobotPartHistoryEntry history = 1;
}

message UpdateRobotPartRequest {
  string part_id = 1;
  string name = 2;
  google.protobuf.Struct robot_config = 3;
}

message UpdateRobotPartResponse {
  RobotPart part = 1;
}

message CreateRobotPartRequest {
  string robot_id = 1;
  string part_name = 2;
}

message CreateRobotPartResponse {
  RobotPart part = 1;
}

message DeleteRobotPartRequest {
  string part_id = 1;
}

message DeleteRobotPartResponse {}


message ListRobotsRequest {
  string location_id = 1;
}

message ListRobotsResponse {
  repeated Robot robots = 1;
}

message CreateRobotRequest {
  string name = 1;
  string location_id = 2;
}

message CreateRobotResponse {
  Robot robot = 1;
}

message UpdateRobotRequest {
  string id = 1;
  string name = 2;
  string location_id = 3;
}

message UpdateRobotResponse {
  Robot robot = 1;
}

message DeleteRobotRequest {
  string robot_id = 1;
}

message DeleteRobotResponse {}

message MarkPartAsMainRequest {
  string part_id = 1;
}

message MarkPartAsMainResponse {}

message CreateRobotPartSecretRequest {
  // Robot Part ID to create the secret in.
  string part_id = 1;
}

message CreateRobotPartSecretResponse {
  RobotPart part = 1;
}

message DeleteRobotPartSecretRequest {
  string part_id = 1;
  string secret_id = 2;
}
message DeleteRobotPartSecretResponse {}
